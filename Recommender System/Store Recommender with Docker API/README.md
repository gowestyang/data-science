# Merchant Recommendation System
Yang Xi, 2021-09-19

## Table of Contents
* Introduction
* Environment Information
* File Directories
* Steps to Run Web Service (Windows Command Line)

<br>

## Introduction
In this exercise, I built a service to recommend 5 merchants to a given user:
* 3 merchants from machine learning model (existing users) or randomly select popular merchants (new users)
* 1 randomly selected "trending" merchant, which increased popularity recently
* 1 randomly selected "new" merchant, which opened a store recently

## Environment Information
* Win10 x64
* Python 3.8.8
* EDA and model dependencies:
    * `numpy==1.19.2`
    * `panda==1.3.2`
    * `fastparquet==0.7.1`
    * `joblib==1.0.1`
    * `matplotlib==3.3.4`
    * `scikit-learn==0.24.2`
    * `tensorflow==2.5.0`
    * `keras==2.4.3`
* API dependencies:
    * `pydantic==1.8.2`
    * `fastapi==0.68.1`
    * `uvicorn==0.15.0`
* Query dependencies:
    * `requests==2.26.0`
* Unit Test dependencies:
    * `nose==1.3.7`
* Container: Developed with Docker Desktop on Win10 x64 with WSL2 backend

## File Directories
* **data/**: This folder contains the provided data.
* **model/**: This folder contains the trained model and cached components for making recommendation.
* **image/**: This folder contains the docker image of the service.
* **1. EDA.ipynb**: This notebook documents the exploratory analysis and observations.
* **2. Model Building and Evaluation.ipynb**: This notebook documents
    * Recommendation Framework
        * high-level design of the recommender
        * potentail directions and challenges not covered by this exercise
    * Model Building and Evalutaion
        * considerations and formulation of user-merchant rating
        * train-test split and relevant considerations
        * model structure
        * performance evaluation based on NDCG
    * Final Model Training
        * train the final model to make recommendation
        * cache other components required by the service
* **3. Model Serving and Unit Test.ipynb**: This notebook documents
    * steps to run the web service
    * sample queries from the API
        * `/predict` endpoint
        * `/batch_predict` endpoint
    * unit test
* **main_recommender.py**: This script defines the web service. Refer to **Steps to Run Web Service** below for its usage.
* **Dockerfile**: Required to build the docker image -- for reference only
* **requirements.txt**: Required to build the docker image -- for reference only

## Steps to Run Web Service (Windows Command Line)
### Start the Service
**Using uvicorn**
* Activate the python environment with desired dependencies
* Navigate to the `root/` directory, which contains `main_recommender.py`
* Execute `uvicorn main_recommender:app --reload --host 127.0.0.1 --port 8000`

**Using docker image**
* Navigate to the `root/image/"`directory, which contains the image `main_recommender.tar`
* Load the image by executing `docker load -i main_recommender.tar`
* Spin up the container by executing `docker run -d -p 8000:8000 --name yangxi-recommender main_recommender`

Once started, the service can be reached at `http://127.0.0.1:8000`

### Service Endpoints
There are two endpoints:
* `/predict`
    * POST with a single key-value pair. For example: `{"user_id":229957}`
        * key: `"user_id"`
        * value: a integer representing the user's ID to query the recommendations
    * Response four key-value pairs.<br>
    For example: `{'user_type':'existing', 'merchant_id':'90', 'ar_merchant_id':'90|326|264|144|272', 'ar_rating':'4.572|4.540|4.449|nan|nan'}`
        * `"user_type"`: `"existing"` or `"new"` indicating whether the recommender treat this users as an existing customer or a new customer.
        * `"merchat_id"`: a string representing the top recommended merchant ID
        * `"ar_merchat_id"`: a pipe-delimited string representing all 5 merchant IDs recommended to the user
        * `"ar_rating"`: a pipe-delimited string representing the predicted rating of the recommendations, sorted from high to low.<br>
        `nan` value means that the recommendation is not generated by the machine learning model.

<br>

* `/batch_predict`
    * POST with a single key-value pair. For example: `{"list_user_id":[229957, 206475]}`
        * key: `"list_user_id"`
        * value: a list of integers representing the user IDs to query the recommendations
    * Response four key-value pairs.<br>
    For example: `{'user_type':'existing,new', 'merchant_id':'90,398', 'ar_merchant_id':'90|326|264|144|36,398|490|271|472|147', 'ar_rating':'4.572|4.540|4.449|nan|nan,nan|nan|nan|nan|nan'}`
        * `"user_type"`: a comma-delimited string with the `user_type` of each `user_id` queried.
        * `"merchat_id"`: a comma-delimited string with the `merchat_id` of each `user_id` queried.
        * `"ar_merchat_id"`: a comma-delimited string with the `ar_merchat_id` of each `user_id` queried.
        * `"ar_rating"`: a comma-delimited string with the `ar_rating` of each `user_id` queried.

### Stop the Service
* If started by uvicorn: `Ctrl+C` to stop the process
* If started by docker: `docker stop yangxi-recommender`

<br>

Refer to **3. Model Serving and Unit Test.ipynb** for sample queries.
